let express = require("express");
const HospitalAdmin = require("../models/hospAdminSchema");
const patientHistory = require("../models/patientHistorySchema");
const BloodBank = require("../models/userHospModels/bloodBankSchema");
const Hospital = require("../models/hospSchema");
const Doctor = require("../models/docSchema");
const patientStats = require("../models/statsSchema/patientStatsSchema");
const doctorStats = require("../models/statsSchema/doctorStatsSchema");
var ObjectId = require("mongodb").ObjectID;

const Appointment = require("../models/appointmentSchema");
const middleware = require("../middlewares/authMiddlewares");
const { populate } = require("../models/docSchema");
const middlewareObj = require("../middlewares/authMiddlewares");

var router = express.Router();

//----------Patient Routes--------------//

// ---------Patient Profile page routes------------//
router.get(
  "/userDocSection/patientDashboard",
  middleware.isLoggedIn,
  function (req, res) {
    patientStats
      .findOne()
      .where("handlerId")
      .equals(req.user._id)
      .exec(function (err, loadingStats) {
        if (err) {
          console.log(err);
        } else {
          res.render("user/dashboards/patientDashboard", {
            isPatient: true,
            patientStats: loadingStats,
          });
        }
      });
    // res.render("user/dashboards/patientDashboard", { isPatient: true });
  }
);

router.get("/userDocSection/createPatientProfile", function (req, res) {
  res.render("user/profilePages/Patient/createPatient");
});

router.post("/userDocSection/createPatientProfile", function (req, res) {
  newPatient = {
    handler: {
      id: req.user._id,
      username: req.user.username,
    },
    prescription: [
      {
        relDoc: req.body.docName,
        presc: {
          docName: req.cody.docName,
          patName: req.user.firstName,
          disease: [req.body.diseaseName],
          medicines: [
            {
              medicineName: req.body.medicineName,
              power: req.body.power,
              dosage: req.body.dosage,
            },
          ],
          test: [req.body.test],
          comment: req.body.comment,
        },
      },
    ],
    // curDoc: [String], //Currently appointed doctors.
    disease: [
      {
        relDoc: req.body.relDoc,
        diseaseName: req.body.diseaseName,
      },
    ],
    appointment: [
      {
        docId: req.body.docId,
        appointId: req.body.appointId,
      },
    ],
  };

  patientHistory.create(newPatient, function (err, newPat) {
    if (err) {
      console.log(err);
    } else {
      res.redirect("/userDocSection/patientDashboard");
    }
  });
});

//----X-----Patient Routes-------X------//

//----------Doctor Routes--------------//

router.get(
  "/userDocSection/docDashboard",
  middleware.isLoggedIn,
  middleware.checkDoctorOwnership,
  function (req, res) {
    doctorStats
      .findOne()
      .where("handlerId")
      .equals(req.user._id)
      .exec(function (err, loadingStats) {
        if (err) {
          console.log(err);
        } else {
          Doctor.findOne(
            { handler_id: ObjectId(req.user._id) },
            { _id: 1 }
          ).exec(function (err, foundDoctor) {
            if (err) {
              console.log(err);
            } else {
              if (foundDoctor == undefined) {
                res.render("user/dashboards/docDashboard", {
                  patientsLength: 0,
                  emergencyPatient: 0,
                  doctorStats: loadingStats,
                });
              } else {
                Appointment.find({
                  docId: foundDoctor._id,
                  activityStatus: true,
                  isEmergency: true,
                })
                  .populate("patientId")
                  .exec(function (err, emergencyPatient) {
                    if (err) {
                      console.log(err);
                    } else {
                      Appointment.distinct("patientId")
                        .where("docId")
                        .equals(foundDoctor._id)
                        .exec(function (error, calculatedPatients) {
                          if (error) {
                            console.log(error);
                          } else {
                            res.render("user/dashboards/docDashboard", {
                              patientsLength: calculatedPatients.length,
                              isDoctor: true,
                              doctorStats: loadingStats,
                              emergencyPatient: emergencyPatient,
                            });
                          }
                        });
                    }
                  });
              }
            }
          });
        }
      });
  }
);

//----X-----Doctor Routes--------x-----//

//----------Hospital Admin Routes--------------//

router.get(
  "/user/hospAdmin/dashboard",
  middleware.isLoggedIn,
  middleware.checkHospAdminOwnership,
  function (req, res) {
    Hospital.find()
      .where("handler.id")
      .equals(req.user._id)
      .exec(function (err, foundHosp) {
        if (err) {
          console.log(err);
        } else {
          HospitalAdmin.find()
            .where("handler.id")
            .equals(req.user._id)
            .exec(function (err, foundAdmin) {
              if (err) {
                console.log(err);
              } else {
                HospitalAdmin.find()
                  .where("handler.id")
                  .equals(req.user._id)
                  .exec(function (err, foundAdmin) {
                    if (err) {
                      console.log(err);
                    } else {
                      res.render("user/dashboards/hospAdminDashboard", {
                        foundHosp: foundHosp,
                        foundAdmin: foundAdmin,
                      });
                    }
                  });
              }
            });
        }
      });
  }
);

router.get(
  "/dashboards/hospAdmin/profileIndex",
  middleware.isLoggedIn,
  middleware.checkHospAdminOwnership,
  function (req, res) {
    Hospital.find()
      .where("handler.id")
      .equals(req.user._id)
      .exec(function (err, foundHosp) {
        if (err) {
          console.log(err);
        } else {
          HospitalAdmin.find()
            .where("handler.id")
            .equals(req.user._id)
            .exec(function (err, foundAdmin) {
              if (err) {
                console.log(err);
              } else {
                res.render("user/profilePages/createProfileIndex", {
                  foundHosp: foundHosp,
                  foundAdmin: foundAdmin,
                });
              }
            });
        }
      });
  }
);

router.get(
  "/dashboards/hospAdmin/hospitalProfile",
  middleware.isLoggedIn,
  function (req, res) {
    res.render("user/profilePages/profileIndexPage/hospitalProfile");
  }
);

router.get(
  "/dashboards/hospAdmin/hospAdminProfile",
  middleware.isLoggedIn,
  function (req, res) {
    res.render("user/profilePages/profileIndexPage/hospAdminProfile");
  }
);

router.get(
  "/dashboards/hospAdmin/otheProfile",
  middleware.isLoggedIn,
  function (req, res) {
    res.render("user/profilePages/profileIndexPage/otherProfile");
  }
);

////```````````Hospital Info post request`````````````///////

router.post(
  "/dashboards/hospAdmin/hospitalProfile",
  middleware.isLoggedIn,
  function (req, res) {
    let newHosp = {
      name: req.body.hospName,
      type: req.body.type,
      speciality: req.body.speciality,
      contact: {
        email: req.body.email,
        phone: req.body.phone,
      },
      handler: {
        id: req.user._id,
        username: req.user.username,
      },
      address: {
        street: req.body.street,
        city: req.body.city,
        state: req.body.state,
        zip: req.body.zip,
      },
      about: req.body.aboutHosp,
    };

    Hospital.create(newHosp, function (err, newHospital) {
      if (err) {
        console.log(err);
      } else {
        res.redirect("/dashboards/hospAdmin/profileIndex");
      }
    });
  }
);

router.get(
  "/user/hospAdmin/dashboard/doctors",
  middleware.isLoggedIn,
  function (req, res) {
    Hospital.findOne()
      .where("handler.id")
      .equals(req.user._id)
      .exec(function (err, foundHosp) {
        if (err) {
          console.log(err);
        } else {
          Doctor.find()
            .where("workingAt")
            .equals(foundHosp._id).populate("handler_id")
            .exec(function (error, foundDoctors) {
              if (error) {
                console.log(error);
              } else {
                res.render("hospHospSection/sideBarPages/doctors", {
                  foundDoctors: foundDoctors,
                });
              }
            });
        }
      });
  }
);

//----------- ViewDoctor Info for Admin --------------
router.get("/hospHospSection/dashboard/doctors/viewDoctor/:docId", middleware.isLoggedIn, function(req, res){
  Doctor.findById(req.params.docId).populate("handler_id")
    .exec(function (error, foundDoctor) {
      if (error) {
        console.log(error);
      } else {
        res.render("hospHospSection/sideBarPages/viewDoctor", {
          doctor: foundDoctor,
        });
      }
  }); 
});
////``````````````Hospital Admin Post request```````````````/////

router.post(
  "/dashboards/hospAdmin/hospAdminProfile",
  middleware.isLoggedIn,
  function (req, res) {
    let newHospAdm = {
      oxyCur: req.body.oxyCur,
      ambCur: req.body.ambCur,
      numBeds: req.body.numBeds,
      partOf: req.body.hospId,
      handler: {
        id: req.user._id,
        username: req.user.username,
      },
      adminContact: {
        email: req.body.email,
        phone: req.body.phone,
      },
    };

    Hospital.findById(req.body.hospId, function (error, foundHosp) {
      if (error) {
        console.log(error);
      } else {
        HospitalAdmin.create(newHospAdm, function (err, newAdmin) {
          if (err) {
            console.log(err);
          } else {
            foundHosp.hasAdmin = true;
            res.redirect("/dashboards/hospAdmin/profileIndex");
          }
        });
      }
    });
  }
);

// ---------Hospital Admin BloodBank, Ambulance,  routes -------------- //

router.post(
  "/dashboards/hospAdmin/otheProfile/bloodbank",
  middleware.isLoggedIn,
  function (req, res) {
    let newBloodbank = {
      name: req.body.name,
      address: {
        street: req.body.street,
        city: req.body.city,
        state: req.body.state,
      },
      relatedTo: req.body.hospId,
      maxcapacity: req.body.maxcapacity,
      currcapacity: {
        opos: req.body.opos,
        oneg: req.body.oneg,

        apos: req.body.apos,
        aneg: req.body.aneg,

        bpos: req.body.bpos,
        bneg: req.body.bneg,

        abpos: req.body.abpos,
        abneg: req.body.abneg,
      },
      handlerId: req.user._id,
      contact: {
        email: req.body.email,
        phone: req.body.phone,
      },
      price: req.body.price,
    };

    BloodBank.create(newBloodbank, function (err, createdBloodbank) {
      if (err) {
        console.log(err);
      } else {
        res.redirect("/dashboards/hospAdmin/profileIndex");
      }
    });
  }
);

router.post(
  "/dashboards/hospAdmin/otheProfile/oxyAmbForm",
  function (req, res) {
    let newData = {
      //Schema pending.
    };
  }
);
// -----X----Hospital Admin BloodBank, Ambulance, other routes ------X-------- //

//-----------------Hospital, Other Profiles Update Routes-------------------//

router.get(
  "/dashboards/hospAdmin/updateProfileIndex",
  middleware.isLoggedIn,
  function (req, res) {
    Hospital.find()
      .where("handler.id")
      .equals(req.user._id)
      .exec(function (err, foundHosp) {
        if (err) {
          console.log(err);
        } else {
          HospitalAdmin.find()
            .where("handler.id")
            .equals(req.user._id)
            .exec(function (err, foundAdmin) {
              if (err) {
                console.log(err);
              } else {
                res.render("user/profilePages/updateProfileIndex", {
                  foundHosp: foundHosp,
                  foundAdmin: foundAdmin,
                });
              }
            });
        }
      });
  }
);

//--------------------------Hospital Update Routes ---------------------//
router.get(
  "/dashboards/hospAdmin/updateHospitalProfile",
  middleware.isLoggedIn,
  function (req, res) {
    Hospital.find()
      .where("handler.id")
      .equals(req.user._id)
      .exec(function (err, foundHosp) {
        if (err) {
          console.log(err);
        } else {
          res.render("user/profilePages/updateProfilePages/updateHosp", {
            foundHosp: foundHosp,
          });
        }
      });
  }
);

router.put(
  "/dashboards/hospAdmin/updateHospitalProfile/:id",
  middleware.isLoggedIn,
  function (req, res) {
    Hospital.findByIdAndUpdate(
      req.params.id,
      req.body.hosp,
      function (err, updateHospital) {
        if (err) {
          // req.flash("error", "Policy not found!")
          console.log(err);
          res.redirect("/dashboards/hospAdmin/updateHospitalProfile");
        } else {
          // req.flash("error", "Policy details succesfully updated!")
          res.redirect("/dashboards/hospAdmin/updateProfileIndex");
        }
      }
    );
    router.get(
      "/dashboards/hospAdmin/updateHospitalProfile",
      middleware.isLoggedIn,
      function (req, res) {
        Hospital.find()
          .where("handler.id")
          .equals(req.user._id)
          .exec(function (err, foundHosp) {
            if (err) {
              console.log(err);
            } else {
              res.render("user/profilePages/updateProfilePages/updateHosp", {
                foundHosp: foundHosp,
              });
            }
          });
      }
    );

    router.put(
      "/dashboards/hospAdmin/updateHospitalProfile/:id",
      middleware.isLoggedIn,
      function (req, res) {
        Hospital.findByIdAndUpdate(
          req.params.id,
          req.body.hosp,
          function (err, updateHospital) {
            if (err) {
              // req.flash("error", "Policy not found!")
              console.log(err);
              res.redirect("/dashboards/hospAdmin/updateHospitalProfile");
            } else {
              // req.flash("error", "Policy details succesfully updated!")
              res.redirect("/dashboards/hospAdmin/updateProfileIndex");
            }
          }
        );
      }
    );
    //------------X-------------Hospital Update Routes ---------X-----------//
    //--------------------------Other Profiles Update Routes ---------------------//

    router.get(
      "/dashboards/hospAdmin/updateOtherProfile",
      middleware.isLoggedIn,
      function (req, res) {
        Hospital.find()
          .where("handler.id")
          .equals(req.user._id)
          .exec(function (err, foundHosp) {
            if (err) {
              console.log(err);
            } else {
              BloodBank.find()
                .where("handler.id")
                .equals(req.user._id)
                .exec(function (err, foundBloodBank) {
                  res.render(
                    "user/profilePages/updateProfilePages/updateHosp",
                    {
                      foundHosp: foundHosp,
                      foundBloodBank,
                      foundBloodBank,
                    }
                  );
                });
            }
          });
      }
    );
  }
);

router.put(
  "/dashboards/hospAdmin/updateOtherProfile/bloodBank/:id",
  middleware.isLoggedIn,
  function (req, res) {
    BloodBank.findByIdAndUpdate(
      req.params.id,
      req.body.bloodBank,
      function (err, updateBloodBank) {
        if (err) {
          // req.flash("error", "Policy not found!")
          console.log(err);
          res.redirect("//dashboards/hospAdmin/updateHospitalProfile");
        } else {
          // req.flash("error", "Policy details succesfully updated!")
          res.redirect("//dashboards/hospAdmin/updateHospitalProfile");
        }
      }
    );
  }
);

//Schema needed.

// router.put("/dashboards/hospAdmin/updateOtherProfile/oxygenAmb/:id", function(req, res){
//     OxyAmb.findByIdAndUpdate(req.params.id, req.body.oxyAmb, function(err, updateOxyAmb){
//         if(err){
//             // req.flash("error", "Policy not found!")
//             console.log(err);
//             res.redirect("//dashboards/hospAdmin/updateHospitalProfile");
//         }else{
//             // req.flash("error", "Policy details succesfully updated!")
//             res.redirect("//dashboards/hospAdmin/updateHospitalProfile");
//         }
//      });
// });

//-------------X------------Other Profiles Update Routes ----------X----------//
//----------X------Hospital, Other Profiles Update Routes----------X--------//

//-----X----Hospital Admin Routes-------X------//

module.exports = router;
